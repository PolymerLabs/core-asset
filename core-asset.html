<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<script>

  (function(global) {

    var requests = new Map();

    global.CoreAsset = Polymer({
      is: 'core-asset',

      published: {
        'href': String
      },

      bind: {
        'href': 'hrefChanged',
      },

      computed: {
        'url': '_getUrl(href)',
        'loaded': '_getLoaded(href)',
        'content': '_getContent(href)',
      },

      created: function() {
        this.baseUri = this.ownerDocument.baseURI;
      },

      _requestAsset: function() {
        var url = this._getUrl();
        var request = this._getRequest();
        if (request == null) {
          request = new XMLHttpRequest();
          requests.set(url.toString(), request);
          request.open("GET", url.toString(), true);
          request.send();
          request.addEventListener('load', this._fire.bind(this));
        } else if (request.readyState == 4) {
          this._fire();
        } else {
          request.addEventListener('load', this._fire.bind(this));
        }
      },

      hrefChanged: function(newValue, oldValue) {
        this._requestAsset();
      },

      _getUrl: function() {
        return new URL(this.href, this.baseUri);
      },

      _getRequest: function() {
        return requests.get(this._getUrl().toString());
      },

      _getContent: function() {
        var request = this._getRequest();
        return request == null ? null : request.response;
      },

      _getLoaded: function() {
        var request = this._getRequest();
        return request != null && request.readyState == 4;
      },

      _fire: function(e) {
        var event = new CustomEvent('content-loaded', { 
          detail: {
            content: this._getContent()
          } 
        });
        this.dispatchEvent(event);
      }

    });
  })(window);

</script>
