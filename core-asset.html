<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<script>

  (function(global) {

    var requests = new Map();

    global.CoreAsset = Polymer({
      is: 'core-asset',

      published: {
        'href': String
      },

      bind: {
        'href': 'hrefChanged',
      },

      configure: function() {
        return {
          url: null,
          loaded: false,
          content: null,
          request: null,
        };
      },

      _resolvePath: function(urlPath) {
        // find <dom-module>
        var domModule = this._template.parentNode;

        // set by vulcanize to represent original paths before inlining
        var assetPath = domModule.getAttribute('assetpath');
        var moduleBase = domModule.ownerDocument.baseURI;

        if (assetPath) {
          // original path to <dom-module> from html import
          moduleBase = new URL(assetPath, moduleBase).href;
        }

        var outUrl = new URL(urlPath, moduleBase);
        return outUrl.href;
      },

      _requestAsset: function() {
        var request = requests.get(this.url);

        if (request === null) {
          this.request = request = new XMLHttpRequest();
          requests.set(urlString, request);
          request.open('GET', this.url, true);
          request.send();
          this._listen();
        } else if (request.readyState == 4) {
          this._fire();
        } else {
          this._listen();
        }
      },

      _listen: function() {
        // listen must only be called on a incomplete request
        this.loaded = false;
        this.content = null;

        this.request.addEventListener('load', (function(e) {

          this.content = this.request.response;
          this.loaded = true;

          var event = new CustomEvent('content-loaded', {
            detail: {
              content: this.content,
            }
          });
          this.dispatchEvent(event);
        }).bind(this));
      },

      hrefChanged: function(newValue, oldValue) {
        this.url = this._resolvePath(this.href);
        this._requestAsset();
      },

    });
  })(window);

</script>
